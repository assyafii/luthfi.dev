<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="Specification : Calico, Containerd, Haproxy, Kubernetes v1.22.x
Lab Topology First, prepare all VM All Nodes except LB Nodes Set mapping hostname nano /etc/hosts Install packages containerd Load overlay and br_netfilter kernal modules.
cat &amp;lt;&amp;lt;EOF | sudo tee /etc/modules-load.d/containerd.conf overlay br_netfilter EOF sudo modprobe overlay sudo modprobe br_netfilter Set these system configurations for Kubernetes networking cat &amp;lt;&amp;lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 EOF Apply settings sudo sysctl --system Install containerd sudo apt-get update &amp;amp;&amp;amp; sudo apt-get install -y containerd sudo mkdir -p /etc/containerd sudo containerd config default | sudo tee /etc/containerd/config." />
<meta name="keywords" content="P4, SDN, Cloud, Openstack, etc., Calico, Containerd, Haproxy, Kubernetes" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="/posts/install-kubernetes-cluster-multi-master-high-availability/" />


    <title>
        
            1. Install Kubernetes cluster multi Master High Availability :: M. Luthfi As Syafii 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.25424a81287dda0fe0e15c0d2e0df95b1d84d2c20a84496978c924ee4be417cb.css">






<meta itemprop="name" content="1. Install Kubernetes cluster multi Master High Availability">
<meta itemprop="description" content="Specification : Calico, Containerd, Haproxy, Kubernetes v1.22.x
Lab Topology First, prepare all VM All Nodes except LB Nodes Set mapping hostname nano /etc/hosts Install packages containerd Load overlay and br_netfilter kernal modules.
cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf overlay br_netfilter EOF sudo modprobe overlay sudo modprobe br_netfilter Set these system configurations for Kubernetes networking cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 EOF Apply settings sudo sysctl --system Install containerd sudo apt-get update &amp;&amp; sudo apt-get install -y containerd sudo mkdir -p /etc/containerd sudo containerd config default | sudo tee /etc/containerd/config."><meta itemprop="datePublished" content="2021-01-01T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-01-01T00:00:00+00:00" />
<meta itemprop="wordCount" content="650"><meta itemprop="image" content="/"/>
<meta itemprop="keywords" content="Calico,Containerd,Haproxy,Kubernetes," />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/"/>

<meta name="twitter:title" content="1. Install Kubernetes cluster multi Master High Availability"/>
<meta name="twitter:description" content="Specification : Calico, Containerd, Haproxy, Kubernetes v1.22.x
Lab Topology First, prepare all VM All Nodes except LB Nodes Set mapping hostname nano /etc/hosts Install packages containerd Load overlay and br_netfilter kernal modules.
cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf overlay br_netfilter EOF sudo modprobe overlay sudo modprobe br_netfilter Set these system configurations for Kubernetes networking cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf net.bridge.bridge-nf-call-iptables = 1 net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 EOF Apply settings sudo sysctl --system Install containerd sudo apt-get update &amp;&amp; sudo apt-get install -y containerd sudo mkdir -p /etc/containerd sudo containerd config default | sudo tee /etc/containerd/config."/>







    <meta property="article:published_time" content="2021-01-01 00:00:00 &#43;0000 UTC" />






<noscript><img src="https://shynet.tommasopifferi.com/ingress/5bf99fb8-5643-4d56-872b-14aa9b66415b/pixel.gif"></noscript> <script src="https://shynet.tommasopifferi.com/ingress/5bf99fb8-5643-4d56-872b-14aa9b66415b/script.js"></script>

    </head>

    <body class="">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            
            <span class="logo__text">luthfi.dev</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/about">About</a></li><li><a href="/posts">Documentation</a></li><li><a href="/resume">Resume</a></li>
    </ul>
</nav>

                <span class="menu-trigger hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        4 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="/posts/install-kubernetes-cluster-multi-master-high-availability/"><ol>
<li>Install Kubernetes cluster multi Master High Availability</li>
</ol>
</a>
      </h1>

      

      <div class="post-content">
        <hr>
<blockquote>
<p>Specification : Calico, Containerd, Haproxy, Kubernetes v1.22.x</p>
</blockquote>
<h3 id="lab-topology"><strong>Lab Topology</strong></h3>
<p><img src="./k8s-topology.png" alt="k8s-topology">
 </p>
<h4 id="first-prepare-all-vm">First, prepare all VM</h4>
<p><img src="./virsh.png" alt="k8s-virsh"></p>
<h3 id="all-nodes-except-lb-nodes"><strong>All Nodes except LB Nodes</strong></h3>
<hr>
<h4 id="set-mapping-hostname">Set mapping hostname</h4>
<pre tabindex="0"><code>nano /etc/hosts
</code></pre><p><img src="./hosts.png" alt="k8s-virsh"></p>
<h4 id="install-packages-containerd">Install packages containerd</h4>
<p>Load overlay and br_netfilter kernal modules.</p>
<pre tabindex="0"><code>cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf 
overlay 
br_netfilter 
EOF
</code></pre><pre tabindex="0"><code>sudo modprobe overlay 
sudo modprobe br_netfilter
</code></pre><h4 id="set-these-system-configurations-for-kubernetes-networking">Set these system configurations for Kubernetes networking</h4>
<pre tabindex="0"><code>cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf 
net.bridge.bridge-nf-call-iptables = 1 
net.ipv4.ip_forward = 1 
net.bridge.bridge-nf-call-ip6tables = 1 
EOF
</code></pre><h4 id="apply-settings">Apply settings</h4>
<pre tabindex="0"><code>sudo sysctl --system
</code></pre><h4 id="install-containerd">Install containerd</h4>
<pre tabindex="0"><code>sudo apt-get update &amp;&amp; sudo apt-get install -y containerd
sudo mkdir -p /etc/containerd
sudo containerd config default | sudo tee /etc/containerd/config.toml
sudo systemctl restart containerd
sudo systemctl enable containerd
</code></pre><h4 id="disable-swap">Disable SWAP</h4>
<pre tabindex="0"><code>sudo swapoff -a
sudo sed -i &#39;/ swap / s/^\(.*\)$/#\1/g&#39; /etc/fstab
</code></pre><h4 id="install-depedency-packages">Install depedency packages</h4>
<pre tabindex="0"><code>sudo apt update &amp;&amp; sudo apt-get install -y apt-transport-https curl
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
</code></pre><h4 id="add-kubernetes-repo">add kubernetes repo</h4>
<pre tabindex="0"><code>cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
deb https://apt.kubernetes.io/ kubernetes-xenial main
EOF
sudo apt update
</code></pre><h4 id="install-kubectl-kubelet--kubeadm-packages">Install kubectl, kubelet, &amp; kubeadm packages</h4>
<pre tabindex="0"><code>sudo apt-get install -y kubelet=1.22.1-00 kubeadm=1.22.1-00 kubectl=1.22.1-00
sudo apt-mark hold kubelet kubeadm kubectl
</code></pre><p> </p>
<h3 id="all-lb-nodes"><strong>All LB Nodes</strong></h3>
<hr>
<h4 id="install-keepalived--haproxy-packages">Install keepalived &amp; HAproxy packages</h4>
<pre tabindex="0"><code>sudo apt install keepalived haproxy psmisc -y
</code></pre><h4 id="configure-haproxy">Configure HAproxy</h4>
<p>Add HAproxy configuration bellow in last line</p>
<pre tabindex="0"><code>sudo nano /etc/haproxy/haproxy.cfg
</code></pre><pre tabindex="0"><code>frontend kubernetes
        bind *:6443 
        option tcplog
        mode tcp
        default_backend kubernetes-master-nodes

backend kubernetes-master-nodes
        mode tcp
        balance roundrobin
        option tcp-check
        server fi-k8s-master-1 10.20.10.201:6443 check fall 3 rise 2
        server fi-k8s-master-2 10.20.10.202:6443 check fall 3 rise 2
        server fi-k8s-master-3 10.20.10.203:6443 check fall 3 rise 2
</code></pre><h4 id="restart-services">Restart services</h4>
<pre tabindex="0"><code>systemctl restart haproxy.service
systemctl status haproxy.service
systemctl enable haproxy.service
</code></pre><h4 id="configure-keepalived">Configure keepalived</h4>
<pre tabindex="0"><code>sudo nano /etc/keepalived/keepalived.conf
</code></pre><h4 id="haproxy-nodes-1">Haproxy nodes 1</h4>
<pre tabindex="0"><code>global_defs {
   notification_email {
     root@localhost
   }
   notification_email_from root@localhost
   smtp_server localhost
   smtp_connect_timeout 30
}

# Script used to check if HAProxy is running
vrrp_script check_haproxy {
    script &#34;killall -0 haproxy&#34;
    interval 2 
    weight 2
}

vrrp_instance VI_1 {
    state MASTER # MASTER on haproxy-nodes-1, BACKUP on haproxy-nodes-2
    interface ens3 # Interface name
    virtual_router_id 255
    priority 101 # 101 on haproxy, 100 on haproxy2
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    unicast_src_ip 10.20.10.101      # IP address of this machine
    unicast_peer {
        10.20.10.102                 # IP address of peer machines
   }
    virtual_ipaddress {
        10.20.10.200
    }
    
    track_script {
        check_haproxy
    }
}
</code></pre><h4 id="haproxy-nodes-2">Haproxy nodes 2</h4>
<pre tabindex="0"><code>global_defs {
   notification_email {
     root@localhost
   }
   notification_email_from root@localhost
   smtp_server localhost
   smtp_connect_timeout 30
}

# Script used to check if HAProxy is running
vrrp_script check_haproxy {
    script &#34;killall -0 haproxy&#34;
    interval 2 
    weight 2
}

vrrp_instance VI_1 {
    state BACKUP # MASTER on haproxy-nodes-1, BACKUP on haproxy-nodes-2
    interface ens3 # Interface name
    virtual_router_id 255
    priority 101 # 101 on haproxy, 100 on haproxy2
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    unicast_src_ip 10.20.10.102      # IP address of this machine
    unicast_peer {
        10.20.10.101                 # IP address of peer machines
   }
    virtual_ipaddress {
        10.20.10.200
    }
    
    track_script {
        check_haproxy
    }
}
</code></pre><h4 id="allow-a-process-to-bind-to-a-non-local-ip-address">Allow a process to bind to a non-local IP address</h4>
<pre tabindex="0"><code>echo &#34;net.ipv4.ip_nonlocal_bind=1&#34; | sudo tee /etc/sysctl.d/ip_nonlocal_bind.conf
sudo sysctl --system
</code></pre><h4 id="restart-keepalived">Restart keepalived</h4>
<pre tabindex="0"><code>sudo systemctl restart keepalived
sudo systemctl status keepalived
sudo systemctl enable keepalived
</code></pre><h4 id="verify-keepalived-ip-address">Verify Keepalived IP Address</h4>
<p>Make sure VRRP IP active only on LB Nodes 1</p>
<p><img src="./keepalived.png" alt="keepalived"></p>
<h3 id="only-master-1-node"><strong>Only Master-1 node</strong></h3>
<hr>
<h4 id="initialize-the-cluster">Initialize the Cluster</h4>
<pre tabindex="0"><code>sudo nano kubeadm-config.yaml
</code></pre><pre tabindex="0"><code>apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
kubernetesVersion: stable
controlPlaneEndpoint: &#34;fi-k8s-vrrp-master:6443&#34;
networking:
    podSubnet: &#34;10.244.0.0/16&#34;    
</code></pre><pre tabindex="0"><code>kubeadm init --config=kubeadm-config.yaml --upload-certs
</code></pre><pre tabindex="0"><code>mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre><h3 id="install-calico-networking-cni">Install Calico Networking (CNI)</h3>
<pre tabindex="0"><code>kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
kubectl get pods -n kube-system
</code></pre><p> </p>
<h3 id="all-master-nodes-except-master-1"><strong>All Master nodes except Master-1</strong></h3>
<hr>
<h4 id="join-master-nodes">Join master nodes</h4>
<pre tabindex="0"><code>kubeadm join fi-k8s-vrrp-master:6443 --token po9o1t.et1h4u50mov73omo \
        --discovery-token-ca-cert-hash sha256:1e0b4eac0402becb5b6ac1a3f1cd52f109f8bfbe32d8a4213a9e37130f67c99b \
        --control-plane --certificate-key fa564b2d3dadaebb8d7690dad2c23a427b2eafd409d0731e67a3ab14050a3872
</code></pre><p> </p>
<h3 id="all-worker-nodes"><strong>All Worker nodes</strong></h3>
<hr>
<h4 id="join-worker-nodes">Join worker nodes</h4>
<pre tabindex="0"><code>kubeadm join fi-k8s-vrrp-master:6443 --token po9o1t.et1h4u50mov73omo \
        --discovery-token-ca-cert-hash sha256:1e0b4eac0402becb5b6ac1a3f1cd52f109f8bfbe32d8a4213a9e37130f67c99b 
</code></pre><p> </p>
<h3 id="verify-all-nodes-already-join"><strong>Verify All nodes already join</strong></h3>
<hr>
<p><code>kubectl get nodes</code></p>
<p><img src="./verify.png" alt="ready"></p>
<h4 id="testing-deploy-pod">Testing deploy POD</h4>
<pre tabindex="0"><code>sudo nano nginx.yaml
</code></pre><pre tabindex="0"><code>apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - name: nginx
    image: nginx:1.14.2
    ports:
    - containerPort: 80
</code></pre><h4 id="running--deploy-pod">Running &amp; deploy POD</h4>
<pre tabindex="0"><code>sudo kubectl apply -f  nginx.yaml    
</code></pre><h4 id="verification">Verification</h4>
<p><img src="./nginx.png" alt="nginx"></p>
<p> </p>
<h4 id="next--install-storage-cluster-rook--ceph-in-kubernetes">Next : Install storage cluster ROOK &amp; CEPH in Kubernetes</h4>
<p> 
 </p>
<h4 id="reference-">Reference :</h4>
<p><a href="https://itnext.io/create-a-highly-available-kubernetes-cluster-using-keepalived-and-haproxy-37769d0a65ba">https://itnext.io/create-a-highly-available-kubernetes-cluster-using-keepalived-and-haproxy-37769d0a65ba</a></p>

      </div>
    </article>

    <hr />

    <div class="post-info">
        <p>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
            <line x1="7" y1="7" x2="7" y2="7"></line>
          </svg><span class="tag"><a href="/tags/calico/">Calico</a></span><span class="tag"><a href="/tags/containerd/">Containerd</a></span><span class="tag"><a href="/tags/haproxy/">Haproxy</a></span><span class="tag"><a href="/tags/kubernetes/">Kubernetes</a></span>
        </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        650 Words
      </p>

      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        2021-01-01 07:00 &#43;0700
      </p>
    </div>

    
      <div class="pagination">
        <div class="pagination__title">
          <span class="pagination__title-h"></span>
          <hr />
        </div>

        <div class="pagination__buttons">
          

          
            <span class="button next">
              <a href="/posts/deploy-storage-cluster-rook-with-ceph-in-kubernetes/">
                <span class="button__text">2. Deploy storage cluster ROOK with CEPH in Kubernetes</span>
                <span class="button__icon">→</span>
              </a>
            </span>
          
        </div>
      </div>
    


    

  </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2023</span>
            
            <span>Made by <a href="http://gohugo.io">Hugo</a></span>
            </span>
        </div>
    </div>
</footer>
            
        </div>

        



<script type="text/javascript" src="/bundle.min.8ea0ff01dfa3348eb00589f8f586e91fbdd52c123c03a22e5d3989256f0764896b02dc521767fb735d737cb971861f5002c6383ddf7ce653bd99a4b1971b8cda.js" integrity="sha512-jqD/Ad&#43;jNI6wBYn49YbpH73VLBI8A6IuXTmJJW8HZIlrAtxSF2f7c11zfLlxhh9QAsY4Pd985lO9maSxlxuM2g==" crossorigin="anonymous"></script>



    </body>
</html>
